# Zoom & Pan Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add scroll-to-zoom, drag-to-pan, and pinch-to-zoom to the PUBG 2D replay map canvas.

**Architecture:** Wrap all PixiJS layers in a `pixi-viewport` Viewport container added to `app.stage`. The Viewport intercepts mouse/wheel/touch events and applies transform (scale + translate) to all child layers at once. Renderers are unchanged — they continue drawing in 800×800 world-space coordinates.

**Tech Stack:** pixi-viewport ^6.0.3 (already installed), pixi.js ^8.16.0, Angular 21

---

### Task 1: Wire up pixi-viewport in the engine

**Files:**
- Modify: `libs/replay-engine/src/lib/engine.ts`

All layers currently live on `app.stage`. Replace that with a single `Viewport` on `app.stage`, and add layers to the viewport instead.

**Step 1: Update engine.ts**

Replace the entire file with:

```typescript
import { Application, Container } from 'pixi.js';
import { Viewport } from 'pixi-viewport';

export class ReplayEngine {
  private app!: Application;
  private viewport!: Viewport;
  private mapLayer!: Container;
  private zoneLayer!: Container;
  private carePackageLayer!: Container;
  private playerLayer!: Container;
  private eventLayer!: Container;

  async init(container: HTMLElement, width: number, height: number): Promise<void> {
    this.app = new Application();
    await this.app.init({
      width,
      height,
      backgroundColor: 0x0d1a0d,
      antialias: true,
    });
    container.appendChild(this.app.canvas);

    this.viewport = new Viewport({
      screenWidth: width,
      screenHeight: height,
      worldWidth: width,
      worldHeight: height,
      events: this.app.renderer.events,
    });

    this.app.stage.addChild(this.viewport);

    this.viewport
      .drag()
      .pinch()
      .wheel()
      .clampZoom({ minScale: 0.5, maxScale: 10 });

    // Build layer stack inside the viewport
    this.mapLayer = new Container();
    this.mapLayer.label = 'map';

    this.zoneLayer = new Container();
    this.zoneLayer.label = 'zones';

    this.carePackageLayer = new Container();
    this.carePackageLayer.label = 'carePackages';

    this.playerLayer = new Container();
    this.playerLayer.label = 'players';

    this.eventLayer = new Container();
    this.eventLayer.label = 'events';

    this.viewport.addChild(this.mapLayer);
    this.viewport.addChild(this.zoneLayer);
    this.viewport.addChild(this.carePackageLayer);
    this.viewport.addChild(this.playerLayer);
    this.viewport.addChild(this.eventLayer);
  }

  getCanvas(): HTMLCanvasElement {
    return this.app.canvas;
  }

  getApp(): Application {
    return this.app;
  }

  getViewport(): Viewport {
    return this.viewport;
  }

  getPlayerLayer(): Container {
    return this.playerLayer;
  }

  getZoneLayer(): Container {
    return this.zoneLayer;
  }

  getEventLayer(): Container {
    return this.eventLayer;
  }

  getCarePackageLayer(): Container {
    return this.carePackageLayer;
  }

  getMapLayer(): Container {
    return this.mapLayer;
  }

  destroy(): void {
    this.app.destroy(true);
  }
}
```

**Step 2: Verify the build compiles**

Run: `npx nx build client --skip-nx-cache`
Expected: Successful build with no TypeScript errors.

**Step 3: Commit**

```bash
git add libs/replay-engine/src/lib/engine.ts
git commit -m "feat: add zoom/pan via pixi-viewport"
```

---

### Task 2: Verify zoom works in the browser

**Step 1: Open the app**

Navigate to `http://localhost:4200` and open a replay.

**Step 2: Smoke test interactions**

- Scroll wheel over the map → map zooms in/out centered on cursor
- Click and drag → map pans
- Pinch on touch device → map pinches to zoom
- Zoom out past the full map → clamped at 0.5× (map never shrinks below half-size)
- Zoom in → clamped at 10× (no infinite zoom)

**Step 3: Confirm no regressions**

- Players render correctly at all zoom levels
- Zones render correctly at all zoom levels
- Kill tracers render correctly
- Timeline and playback controls still work

---

## Notes

- No renderer code changes are needed — all renderers draw in world-space (0–800) and the viewport transform handles zoom/pan visually.
- `clampZoom` options: `minScale: 0.5` keeps the full map always at least half-screen. Adjust to taste.
- `pixi-viewport` docs: https://davidfig.github.io/pixi-viewport/
